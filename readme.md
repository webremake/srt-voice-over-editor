# **SRT Voice-over Editor (Gemini API + gemini-3)**

## **Назначение**
Этот скрипт предназначен для **профессионального редактирования субтитров в формате SRT для озвучки (voice-over)** с помощью моделей Gemini API (например, `gemini-3-flash`).

Скрипт:
- делает текст лаконичным и удобным для произношения,
- сохраняет 100% смысла и ключевые сущности (имена, бренды),
- гарантирует сохранение структуры и таймкодов SRT благодаря использованию библиотеки `pysrt`.

------

## **Архитектура решения**
Пайплайн обработки:

```
SRT (pysrt)
 ↓
Разбивка на батчи (по 50 строк)
 ↓
Форматирование в нумерованный список
 ↓
Gemini API (gemini-3-flash)
 ↓
Парсинг ответа и валидация количества строк
 ↓
SRT (pysrt) + Сохранение
```

Ключевая особенность:
**Логика нумерованных списков (Numbered Batching)** в сочетании с библиотекой `pysrt` исключает "галлюцинации" модели в плане структуры. Модель видит только текст, а `pysrt` отвечает за сохранение оригинальных таймкодов.

------

## **Требования**

### **1. API Ключ**
Необходим `GEMINI_API_KEY`. Получить его можно в [Google AI Studio](https://aistudio.google.com/).

### **2. Переменные окружения**
Создайте файл `.env` в корне проекта:
```env
GEMINI_API_KEY=your_api_key_here
```

### **3. Python-зависимости**
Установите необходимые библиотеки:
```bash
pip install google-generativeai pysrt python-dotenv
```

------

## **Что делает скрипт по шагам**

1. **Загружает SRT**: использует библиотеку `pysrt` для надежной работы с форматом.
2. **Батчинг**: разбивает файл на порции по 50 блоков (настраивается через `chunk_size`).
3. **Редактирование**:
   - Формирует нумерованный список строк.
   - Отправляет запрос к `gemini-3-flash-preview`.
   - При несоответствии количества строк в ответе — автоматически уменьшает батч до 5 строк и пробует снова (retry logic).
4. **Rate Limiting**: делает паузу 15 секунд между запросами для соблюдения лимитов Free Tier (5 RPM).
5. **Сжатие**: модель удаляет лишние слова, вводные конструкции и разговорный мусор, сохраняя при этом все имена собственных и бренды.

------

## **Запуск**

```bash
python script.py
```

По умолчанию:
- **Вход**: `input.srt`
- **Выход**: `output_voiceover.srt`

Изменить файлы можно в блоке `if __name__ == "__main__":` в `script.py`.

------

## **Гарантии**
Благодаря `pysrt` и строгому системному промпту:
- ❌ Таймкоды **никогда** не меняются.
- ❌ Количество блоков остается неизменным.
- ❌ Имена и термины защищены от удаления.

---

## **Советы по качеству**
Для проверки результата рекомендуется использовать скрипт `generate_report.py` (если он есть в вашем наборе инструментов), который создает таблицу сравнения ДО/ПОСЛЕ с расчетом скорости речи (символов в секунду).